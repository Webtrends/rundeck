#!/bin/bash

#
# OpenLDAP backup script generated for <%= node['hostname'] %>
#
# Managed by Chef
#

# backup directory
BACKUP_DIR=<%= node['wt_openldap']['server_backup']['mount_path'] %>/ldap/<%= node['fqdn'] %>

# backup file name
BACKUP_FILE=$BACKUP_DIR/ldap-backup-<%= node['fqdn'] %>-$( date +%Y%m%d-%H%M ).ldif

# run backup
/usr/sbin/slapcat -v -o ldif-wrap=no -l $BACKUP_FILE

# remove old backups
find $BACKUP_DIR -mtime +<%= node['wt_openldap']['server_backup']['num_backups_retained'] %> -delete

# create scrubbed backups for lab
/usr/sbin/slapcat -o ldif-wrap=no | \
	perl -pe '
		BEGIN { $i = 0 }
		if (/^dn:/) { $AnonUser = 0; $i++ }
		if (!/webtrends.com/i && /^dn: mail=/) {
			$AnonUser = 1;
			s/^(dn: mail=)[^,]*(,.*)/\1AnonymousUserMail-$i\2/
		}
		if ($AnonUser) {
			s/^(mail: ).*/\1AnonymousUserMail-$i/;
			s/^(givenName: ).*/\1AnonymousUserGivenName-$i/;
			s/^(cn: ).*/\1AnonymousUserCn-$i/
		}
		s/^(userPassword:: ).*/\1REMOVED/
	' >  $BACKUP_DIR/ldap-scrubbed-backup-<%= node['fqdn'] %>.ldif

