#!/bin/sh

# Setup basic path information.
EXEC=/usr/bin/jsvc
MAIN=com.webtrends.streaming.StreamCollectionServer

USER="<%= node[:user] %>"
LOG_PID="<%= node[:log_dir] %>/streaming-collection.pid"
LOG_OUT="<%= node[:log_dir] %>/streaming-collection.out"
LOG_ERR="<%= node[:log_dir] %>/streaming-collection.err"
JAVA_HOME="<%= node[:java_home] %>"
HOME_DIR="<%= node[:install_dir] %>/<%= node[:name] %>"

# Setup classpath, initially empty.
CP=""

# Add all .jar files to the classpath.
for jar in `ls $HOME_DIR/lib/*`; do
    if [ "" = "$CP" ]; then
        CP=$jar
    else
        CP=$CP:$jar
    fi
done

# Add all configuration files to the classpath.
for conf in `ls $HOME_DIR/conf/*`; do
    if [ "" = "$CP" ]; then
        CP=$conf
    else
        CP=$CP:$conf
    fi 
done

# Create the JSVC command line.
CMD="$EXEC -home $JAVA_HOME -cp $CP -user $USER -outfile $LOG_OUT -errfile $LOG_ERR -pidfile $LOG_PID"

# Chack what the caller wants.
case "$1" in
    start)
        if [ ! -f "$LOG_PID" ]; then
            cd $HOME_DIR
            `$CMD $MAIN`
        else 
            echo "Service already running! File $LOG_PID exists!"
        fi
        ;;
    stop)
        if [ -f "$LOG_PID" ]; then
            cd $HOME_DIR
            `$CMD -stop $MAIN`
        else
            echo "Service not running? File $LOG_PID not exist."
        fi 
        ;;
    status)
        # Status is found via actual running processes, rather than
        # trusting the PID log file.
        FOUND=`ps -ef |grep $MAIN |grep -v grep`
        if [ "" = "$FOUND" ]; then
            echo "Not running"
            exit 1
        else
            echo "Running"
            exit 0
        fi
        ;;
    restart)
        if [ -f "$LOG_PID" ]; then
            cd $HOME_DIR
            `$CMD -stop $MAIN`
            `$CMD $MAIN`
        else
            echo "Service not running? File $LOG_PID not found."
            exit 1
        fi
        ;;
    *)
        echo "usage: daemon {start|stop|status|restart}" >&2
        exit 1
        ;;
esac