#!/bin/sh

# Setup basic path information.
EXEC=/usr/bin/jsvc 
MAIN=com.webtrends.streaming.websocket.StreamingAPIDaemon
USER="<%= @user %>"
LOG_PID="<%=File.join(@log_dir,"streaming-api.pid")%>"
LOG_OUT="<%=File.join(@log_dir,"streaming-api.out")%>"
LOG_ERR="<%=File.join(@log_dir,"streaming-api.err")%>"
HOME_DIR="<%=@install_dir%>"

# Setup classpath, initially empty.
CP=""

# Add all .jar files to the classpath.
for jar in `ls $HOME_DIR/lib/*`; do
    if [ "" = "$CP" ]; then
        CP=$jar 
    else
        CP=$CP:$jar
    fi
done

if [ -z "$JMX_OPTS" ]; then
    JMX_OPTS="-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false "
fi
if [ -z "$JMX_PORT" ]; then
    JMX_PORT="9999"
fi

JMX_OPTS="$JMX_OPTS -Dcom.sun.management.jmxremote.port=$JMX_PORT "

# Add all configuration files to the classpath.
for conf in `ls $HOME_DIR/conf/*`; do
    if [ "" = "$CP" ]; then
        CP=$conf
    else
        CP=$CP:$conf
    fi 
done

# Create the JSVC command line.
CMD="$EXEC -home <%=@java_home%> -cp $CP -user $USER -outfile $LOG_OUT -errfile $LOG_ERR -pidfile $LOG_PID -Dcom.webtrends.log.dir=<%=@log_dir%> $JMX_OPTS"
 
# Check what the caller wants.
case "$1" in
    start)
        if [ ! -f "$LOG_PID" ]; then
            cd $HOME_DIR
            echo $CMD $MAIN
            `$CMD $MAIN`
        else 
            echo "Service already running! File $LOG_PID exists!"
        fi
        ;;
    stop)
        if [ -f "$LOG_PID" ]; then
            cd $HOME_DIR
            `$CMD -stop $MAIN`
        else
            echo "Service not running? File $LOG_PID not exist."
        fi 
        ;;
    status)
        # Status is found via actual running processes, rather than
        # trusting the PID log file.
        FOUND=`ps -ef |grep $MAIN |grep -v grep`
        if [ "" = "$FOUND" ]; then
            echo "Not running"
            exit 1
        else
            echo "Running"
            exit 0
        fi
        ;;
    restart)
        if [ -f "$LOG_PID" ]; then
            cd $HOME_DIR
            `$CMD -stop $MAIN`
            `$CMD $MAIN`
        else 
            echo "Service not running? File $LOG_PID not found."
            exit 1
        fi
        ;;
    *)
        echo "usage: daemon {start|stop|status|restart}" >&2
        exit 1
        ;;
esac