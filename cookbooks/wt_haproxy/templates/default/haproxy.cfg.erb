global
  log 127.0.0.1   local0
  log 127.0.0.1   local1 notice
  #log loghost    local0 info
  maxconn <%= node['haproxy']['global_max_connections'] %>
  #debug
  #quiet
  user <%= node['haproxy']['user'] %>
  group <%= node['haproxy']['group'] %>

defaults
  log     global
  mode    http
  retries 3
 <% @defaults_timeouts.sort.map do | value, time | -%>
	  timeout <%= value %> <%= time %>
 	  <% end -%>
 <% @defaults_options.sort.each do | option | -%>
 	  option <%= option %>
 	  <% end -%>

  balance  <%= node['haproxy']['balance_algorithm'] %>

# Set up application listeners here.

frontend http
  maxconn <%= node['haproxy']['frontend_max_connections'] %>
  bind <%= node['haproxy']['incoming_address'] %>:<%= node['haproxy']['incoming_port'] %>
<% @proxy_inf.keys.each do |p| -%>
	acl <%= 'has_' + p.name %>  path_beg <%= p.default_attributes["wt_haproxy"]["endpoint"] %>
	use_backend <%= p.name %> if <%= 'has_' + p.name %>
<% end -%>
  default_backend servers-http

backend servers-http
  server localhost 127.0.0.1:4000 weight 1 maxconn <%= node['haproxy']['member_max_connections'] %> check

<% @proxy_inf.keys.each do |p| -%>
backend <%= p.name %>
	<% @proxy_inf[p].each do |svr| %>
	server <%= svr.name %> <%= svr.ipaddress %> weight 1 maxconn <%= node['haproxy']['member_max_connections'] %>  <%= p.default_attributes["wt_haproxy"]["healthcheck"] %>

	<% end -%>

<% end-%>



<% if node['haproxy']['enable_admin'] -%>
listen admin <%= node['haproxy']['admin']['address_bind'] %>:<%= node['haproxy']['admin']['port'] %>
  mode http
  stats uri /
<% end -%>

