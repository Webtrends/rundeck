<VirtualHost *:80>
        ServerName <%= node['wt_opt_ots']['frontend_url']%>
        ServerAlias <%= node['hostname'] %>
        ServerAlias <%= node['fqdn'] %>
        ServerAdmin <%= node['wt_common']['admin_email']%>
        ErrorLog /var/log/apache2/ots-<%= node['chef_environment'] %>_error.log

        Header set p3p "CP=\"NOI DSP COR NID ADM DEV PSA OUR IND UNI PUR COM NAV INT STA\""

        DocumentRoot /var/www
        ServerSignature On
	LimitRequestLine 16320

        ErrorDocument 404 http://optimize.webtrends.com/404/
        ErrorDocument 403 http://optimize.webtrends.com/404/
        ErrorDocument 503 http://optimize.webtrends.com/503/

        <Proxy *>
                Order deny,allow
                Allow from all
        </Proxy>

        ProxyPass        /ots http://localhost:8080/ots
        ProxyPassReverse /ots http://localhost:8080/ots

        <Directory />
                Options FollowSymLinks
                AllowOverride None
        </Directory>

        <Location /server-status>
          SetHandler server-status

          Order Deny,Allow
          Deny from all
          Allow from 127.0.0.1
        </Location>

</VirtualHost>

<% if node['wt_opt_ots']['ssl'] -%>
<VirtualHost *:443>
        ServerName <%= node['wt_opt_ots']['frontend_url']%>
        ServerAlias <%= node['hostname'] %>
        ServerAlias <%= node['fqdn'] %>
        ServerAdmin ops@<%= node['domain']%>
        ErrorLog /var/log/apache2/ots-<%= node['chef_environment'] %>_error.log
        TransferLog /var/log/apache2/ots-<%= node['chef_environment'] %>_access.log

        Header set p3p "CP=\"NOI DSP COR NID ADM DEV PSA OUR IND UNI PUR COM NAV INT STA\""

        DocumentRoot /var/www
        ServerSignature On
	LimitRequestLine 16320

        ErrorDocument 404 http://optimize.webtrends.com/404/
        ErrorDocument 403 http://optimize.webtrends.com/404/
        ErrorDocument 503 http://optimize.webtrends.com/503/

        <Proxy *>
                Order deny,allow
                Allow from all
        </Proxy>

        ProxyPass        /ots http://localhost:8080/ots
        ProxyPassReverse /ots http://localhost:8080/ots
        SSLEngine on
        SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
        SSLCertificateKeyFile /etc/apache2/ssl/ots.optimize.webtrends.com.pem
        SSLCertificateFile /etc/apache2/ssl/ots.optimize.webtrends.com.pem
        SetEnvIf User-Agent ".*MSIE.*" \
                  nokeepalive ssl-unclean-shutdown \
                  downgrade-1.0 force-response-1.0

        <Directory />
                Options FollowSymLinks
                AllowOverride None
        </Directory>
</VirtualHost>
<% end -%>
