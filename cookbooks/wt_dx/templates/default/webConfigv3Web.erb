<?xml version="1.0" encoding="utf-8"?>
<configuration>
    <configSections>
        <section name="cacheConfiguration" type="Webtrends.Cache.Configuration.CacheConfigurationSection, Webtrends.Cache2" />
        <section name="CassandraCluster" type="Webtrends.Cassandra.Core.CassandraClusterConfigSection, Webtrends.Cassandra.Core,Version=1.0.0.0, Culture=neutral" />
    </configSections>
    
    <appSettings>
        <add key="proxy" value="" />
        <add key="streamingServiceRoot" value="<%= @streamingservice_root %>" />
        <add key="ProfileDefaultExtractionDelayMinutes" value="120" />
        <add key="ignoreSpaceRights" value="false" />
        <!--
        120 days is what the data scheduler UX has, but that is because they show the ones that have been deleted.
        The Extraction service doesn't show the extracts that have been deleted so shorten up the days so that
        few extract history is pulled over the wire and then discarded because the extract has been deleted
        by the retention process, which is 7 days.
        -->
        <add key="extractHistoryDays" value="14" />
    </appSettings>
    
    <connectionStrings>
        <add name="wtMasterConnection" connectionString="server=<%= @master_host %>;Trusted_Connection=true;database=wtMaster;connection timeout=30" providerName="System.Data.SqlClient"></add>
    </connectionStrings>
    
    <CassandraCluster KeySpace="Webtrends" ReportColumnFamily="<%= @report_col %>" MetaDataColumnFamily="<%= @metadata_col %>" SnmpCommunity="<%= @snmp_comm %>" SnmpPort="1161" ThriftPort="9160">
        <Nodes>
    <% @cassandra_hosts.each do |host| -%>
	  	<add Hostname="<%= host %>"/>
	  <% end -%>
        </Nodes>
    </CassandraCluster>
    
    <cacheConfiguration enabled="true" region="<%= @cache_name %>" protocol="Binary" lifespan="00:15:00">
        <servers>
        		<% @cache_hosts.each do |cache| -%>
            <add address="<%= cache['name'] %>" Port="<%= cache['port'] %>"/>
            <% end -%>
        </servers>
        <socketPool minPoolSize="2" maxPoolSize="100" connectionTimeout="00:00:10" receiveTimeout="00:00:05" deadTimeout="00:02:00" />
    </cacheConfiguration>
    
    <system.web>
        <httpRuntime requestValidationMode="2.0" maxQueryStringLength="8048" />
        <compilation debug="true" targetFramework="4.0" />
        <customErrors mode="Off"/>
    </system.web>
    
    <system.webServer>
        <modules runAllManagedModulesForAllRequests="true">
            <remove name="ServiceModel" />
            <add name="UrlRoutingModule" type="System.Web.Routing.UrlRoutingModule, System.Web, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
        </modules>
        <security>
            <requestFiltering>
                <requestLimits maxAllowedContentLength="30000000" maxUrl="8048" maxQueryString="8048" />
            </requestFiltering>
        </security>
    </system.webServer>
    
    <system.serviceModel>
        <serviceHostingEnvironment aspNetCompatibilityEnabled="true" />
        <standardEndpoints>
            <webHttpEndpoint>
            <!-- 
                Configure the WCF REST service base address via the global.asax.cs file and the default endpoint 
                via the attributes on the <standardEndpoint> element below
            -->
            <standardEndpoint name="" helpEnabled="true" automaticFormatSelectionEnabled="false" />
            </webHttpEndpoint>
        </standardEndpoints>
        <!--- The settings below are for space/profile search parameter functionality -->
        <bindings>
            <netTcpBinding>
            <binding name="TcpBinding" closeTimeout="00:01:00" openTimeout="00:01:00" receiveTimeout="00:30:00" sendTimeout="00:01:00" transactionFlow="false" transferMode="Streamed" transactionProtocol="OleTransactions" hostNameComparisonMode="StrongWildcard" listenBacklog="10" maxBufferPoolSize="524288" maxBufferSize="2147483647" maxConnections="1000" maxReceivedMessageSize="2147483647">
                <readerQuotas maxDepth="2147483647" maxStringContentLength="8192" maxArrayLength="2147483647" maxBytesPerRead="4096" maxNameTableCharCount="16384" />
                <reliableSession ordered="true" inactivityTimeout="01:00:00" enabled="false" />
                <security mode="None">
                <transport clientCredentialType="None" protectionLevel="EncryptAndSign" />
                <message clientCredentialType="None" />
                </security>
            </binding>
            </netTcpBinding>
        </bindings>
        <client>
            <endpoint address="<%= @endpoint_address %>" binding="netTcpBinding" bindingConfiguration="TcpBinding" contract="SearchService.ISearch" name="TcpBinding" behaviorConfiguration="ServiceBehavior" />
        </client>
        <behaviors>
            <endpointBehaviors>
            <behavior name="ServiceBehavior">
                <protobuf />
            </behavior>
            </endpointBehaviors>
        </behaviors>
        <extensions>
            <behaviorExtensions>
            <add name="protobuf" type="ProtoBuf.ServiceModel.ProtoBehaviorExtension, protobuf-net" />
            </behaviorExtensions>
        </extensions>
    </system.serviceModel>
    <system.webServer>
        <handlers>
            <add name="svc-ISAPI-2.0_32bit" path="*.SVC" verb="*" modules="IsapiModule" scriptProcessor="C:\Windows\Microsoft.NET\Framework\v2.0.50727\aspnet_isapi.dll" resourceType="Unspecified" preCondition="classicMode,runtimeVersionv2.0,bitness32" />
      			<add name="svc-ISAPI-2.0_64bit" path="*.SVC" verb="*" modules="IsapiModule" scriptProcessor="C:\Windows\Microsoft.NET\Framework64\v2.0.50727\aspnet_isapi.dll" resourceType="Unspecified" preCondition="classicMode,runtimeVersionv2.0,bitness64" />          
      </handlers>
    </system.webServer>
</configuration>