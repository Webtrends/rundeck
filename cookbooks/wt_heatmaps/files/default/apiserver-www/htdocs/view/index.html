<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">

$(document).ready(function ()
{
	var heatmap_img_cache = {};
	$("#pages").change(function ()
	{
		$("#key").val($("#pages").val());
	});
	
	$("#view-button").click(function ()
	{
		var page = $("#key").val(); // page we want to heat heatmap for, currently use a URI
		if (page == "")
		{
			alert("Choose a page");
			return;
		}
		
		
		$("#view-button").val("Requesting..");
		var dot = $("#size").val(); // size of heatmap brush to use (should be between 10 and 90)
		var filter = $("#filter").val(); // rasterization filter to use to create our visualization
		
		
		var iframe = $("#heatmap_container iframe");
		var w = iframe.width();
		var h = iframe.height();
		$.getJSON("http://vhmapi01.staging.dmz/heatmap_meta.php?callback=?" // make jsonp request to get the heatmap meta information (specifically 'y_max' and 'coef')
		, {
			page: page
			, startd: $("#startd").val()
			, stopd: $("#stopd").val()
			, dot: dot
			, filter: filter
			, w: w
			, accountid: $("#accountid").val()
		}, function (data) {
			$("#view-button").val("Fetching..");
			var y_max = data["y_max"]; // how tall the heatmap is
			
			if (y_max < 400) // If the furthest down click is under 400px, make the window size 400px at the least
				y_max = 400;
			else
				y_max += 175; // Add 175px to the height of heatmaps so we don't cut of footers as much
			
			// we have everyting we need at this point.  Now resize the height of the heatmap view to y_max
			$("#heatmap_container iframe").animate({
				height: y_max
			}, 1000, function ()
			{
				$("#view-button").val("Render");
				var stride = 200; // hight of the heatmap blocks.  should always be 200
				var buf="";

				// load all the heatmap blocks
				var cnt=0;
				var t_h = y_max;
				while (t_h > 0)
				{
					var h = stride;
					if (t_h - h < 0) // last block might be smaller than the normal block height (200px)
						h = t_h;

					// URL to heatmap blocks
					var img_src = "http://vhmapi01.staging.dmz/heatmap.php?w="+w
									+"&h="+stride
									+"&dot="+dot
									+"&filter="+filter
									+"&coef="+data["coef"]
									+"&startd="+$("#startd").val()
									+"&stopd="+$("#stopd").val()
									+"&top="+(cnt*stride)
									+"&i="+cnt
									+"&accountid="+$("#accountid").val()
									+"&page="+escape(page);

					// stick in heatmap_img_cache so if they re-request a heatmap they already looked at, we already have the images for it
					heatmap_img_cache[img_src] = new Image();
					heatmap_img_cache[img_src].src = img_src;

					buf += "<img style=\"position: absolute; top: "+ (cnt*stride) +"px; padding: 0px; margin: 0px;\" src=\"" + img_src + "\" width=\"" + w + "\" height=\"" + h + "\" />";
					t_h -= h;
					++cnt;
				}
				
				$("#overlay").html(buf);
				$("#overlay").show();
			});
		});
	});
});

</script>
<style type="text/css">

* {
	font-family: sans-serif;
	font-size: 10pt;
}

#header {
	background-color: #000;
	color: #fff;
}

#header ul {
	padding: 4px;
	list-style: none;
}

#header input[type="text"] {
	border: 0px;
	padding: 4px;
}

#heatmap_container {
	padding: 5px;
	background-color: 000;
}

#heatmap_container iframe {
	width: 100%;
	height: 500px;
	border: 0px;
}

#overlay {
	position: absolute;
}

</style>
</head>
<body>
<div id="header">
	<form>
		<ul>
			<li>Start Date:  <input type="text" id="startd" value="2012-02-01" /></li>
			<li>Stop Date:  <input type="text" id="stopd" value="2012-02-02" /></li>
			<li>Account ID: <input type="text" id="accountid" value="21542" /></il>
			<li>
				size:
				<select id="size">
					<option>90</option>
					<option>80</option>
					<option selected="selected">70</option>
					<option>60</option>
					<option>50</option>
					<option>40</option>
					<option>30</option>
					<option>20</option>
					<option>10</option>
				</select>
			</li>
			<li>
				filter:
				<select id="filter">
					<option>infrared</option>
					<option>warmth</option>
					<option>focus</option>
					<option>highlight</option>
				</select>
			</li>
			<li>
				page:
				<select id="pages">
					<option value=""> - Choose - </option>
					<option value="webtrends.com;42099b4af021e53fd8fd4e056c2568d7c2e3ffa8">(webtrends.com;42099b4af021e53fd8fd4e056c2568d7c2e3ffa8) /</option>
					<option value="webtrends.com;5f76bea9e248ad336a628dc54ccd4c1ab053ad15">(webtrends.com;5f76bea9e248ad336a628dc54ccd4c1ab053ad15  /support/software-center/) </option>
					<option value="webtrends.com;758a1889e669ab7f95a404fdbb0804c46b4d015f">(webtrends.com;758a1889e669ab7f95a404fdbb0804c46b4d015f) /products/optimize/</option>
					<option value="webtrends.com;7e5749e49898bb4d0b817901fc10908729e6987a">(webtrends.com;7e5749e49898bb4d0b817901fc10908729e6987a) /support/</option>
					<option value="webtrends.com;a984620d9e657930155c1acdf5a17bed8a748580">(webtrends.com;a984620d9e657930155c1acdf5a17bed8a748580) /solutions/social/</option>
					<option value="webtrends.com;ed35ac52f159a1406dbfc1ecd3092acebf5503ff">(webtrends.com;ed35ac52f159a1406dbfc1ecd3092acebf5503ff) /solutions/mobile/</option>
					<option value="www.motorcycle-superstore.com;3e41d3537254d4ca451b3c8120c2b200ec93d05f">(www.motorcycle-superstore.com;3e41d3537254d4ca451b3c8120c2b200ec93d05f) motorcycle-usa test-log.  account-id: 20408</option>
				</select>
				<br/><input type="text" id="key" value="" style="width: 600px;" />
			</li>
			<li>
				<input id="view-button" type="button" value="Render" />
			</il>
		</ul>
	</form>
</div>
<div id="heatmap_container">
	<div id="overlay">
	</div>
	<iframe src="http://webtrends.com/"></iframe>
</div>
</body>
</html>