# bootstrap chef

#set run_list = $getVar('run_list','')
#set environment = $getVar('environment','')

# set the clock
ntpdate <%= @node[:ntp][:servers][0] %>

# install chef
yum -y --nogpgcheck install gcc make ruby-devel ruby rubygems
gem sources -a <%= @node[:wt_common][:gem_repo] %>
gem install chef -v <%= @node[:cobbler][:deploy_chef_version] %>
gem install ohai
chkconfig chef-client on

# create chef config dir
mkdir /etc/chef

# fetch validation.pem
wget -O /etc/chef/validation.pem http://$http_server/$dnsdomainname.pem

# create client.rb
cat > /etc/chef/client.rb << EOF
log_level        :info
log_location     STDOUT
chef_server_url  "$chef_server"
validation_client_name 'chef-validator'
EOF

# generate first run json
runlist=$run_list
realrunlist=\$(for item in \${runlist//,/ }; do echo -n "\"${item}\","; done | sed 's/,$//')
echo "{ \"run_list\": [ $realrunlist ] }" > /etc/chef/first-boot.json

# set chef environment if environment is specified
if [[ -n "$environment" ]] ; then
  chef_environment="-E $environment"
fi

# run chef for the first time and set environment
if [[ `expr length "$environment"` -eq 1 ]]; then
	echo "{ \"run_list\": [ \"recipe[wt_base::set_environment]\" ] }" > /etc/chef/set-environment.json
	CHEF_ENVIRONMENT=$environment chef-client -j /etc/chef/set-environment.json
	rm /etc/chef/set-environment.json
else
	chef-client ${chef_environment} -j /etc/chef/first-boot.json
fi

# run chef for the first time after setting environment
chef-client -j /etc/chef/first-boot.json

# cleanup
chmod 600 /etc/chef/validation.pem
rm /etc/chef/first-boot.json

