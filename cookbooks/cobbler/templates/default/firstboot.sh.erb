#!/bin/bash -xv
#
# Preseed firstboot script
#

exec > >(tee /root/firstboot.log) 2>&1

# setup chef repo
echo "deb <%= node['cobbler']['apt']['url'] %> $(lsb_release -c -s) main" > /etc/apt/sources.list.d/cobbler.list
apt-get update

mkdir /etc/chef

# install chef
case "$(lsb_release -c -s)" in
<% @chef_versions.each do |codename, chef_version| %>
"<%= codename %>")
  apt-get --assume-yes --allow-unauthenticated install chef=<%= chef_version %>
  ;;
<% end %>
*)
  apt-get --assume-yes --allow-unauthenticated install chef
  ;;
esac

# create client.rb
cat > /etc/chef/client.rb << EOF
log_level        :info
log_location     STDOUT
chef_server_url  "$(cat /var/tmp/chef_server)"
validation_client_name 'chef-validator'
EOF

# generate first boot json
runlist=$(cat /var/tmp/runlist)
realrunlist=$(for item in ${runlist//,/ }; do echo -n "\"${item}\","; done | sed 's/,$//')
echo "{ \"run_list\": [ $realrunlist ] }" > /etc/chef/first-boot.json

# set chef environment if running chef 0.10+ and environment is specified
environment=$(cat /var/tmp/environment)
if [[ ! `chef-client --version` =~ 0\.9\.* && -n "$environment" ]] ; then
  chef_environment="-E $environment"
fi

/etc/init.d/chef-client stop

# run chef for the first time and set environment
if [[ `expr length "$environment"` -eq 1 ]]; then
  echo "{ \"run_list\": [ \"recipe[wt_base::set_environment]\" ] }" > /etc/chef/set-environment.json
  CHEF_ENVIRONMENT=$environment chef-client -j /etc/chef/set-environment.json
  rm /etc/chef/set-environment.json
else
  chef-client ${chef_environment} -j /etc/chef/first-boot.json
fi

# run chef for the first time after setting environment
chef-client ${chef_environment} -j /etc/chef/first-boot.json

/etc/init.d/chef-client restart

# cleanup
chmod 600 /root/firstboot.log
rm /etc/chef/validation.pem
rm /etc/chef/first-boot.json
rm /var/tmp/runlist /var/tmp/environment /var/tmp/chef_server
rm /etc/apt/sources.list.d/cobbler.list 
