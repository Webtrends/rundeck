<% ports = [ 80 ] %>
<% ports << 443 if @use_ssl %>
<% ports.each do |port| -%>
<VirtualHost *:<%= port %>>
        ServerName <%= @hostname %>
        ServerAdmin <%= @email %>
<% if @use_ssl && port == 80 %>
        RewriteEngine On
<% unless @allow_local_https %>
        RewriteCond %{REMOTE_ADDR} !^<%= node['ipaddress'] %>$
<% end %>
        RewriteRule ^/?(.*) https://<%= @hostname %>/$1 [R=301,L]
<% end %>

        ErrorLog <%= @log_dir %>/rundeck_error.log
        TransferLog <%= @log_dir %>/rundeck_access.log

<% if @use_ssl && port == 443 %>
        RequestHeader set X-Forwarded-Proto "https"
        SSLEngine On
        SSLCertificateFile <%= node['apache']['dir'] %>/ssl/<%= @cert_name %>.crt
        SSLCertificateKeyFile <%= node['apache']['dir'] %>/ssl/<%= @cert_name %>.key
<% unless @ca_cert_name.nil? %>
        SSLCertificateChainFile <%= node['apache']['dir'] %>/ssl/<%= @ca_cert_name %>.crt
<% end %>
<% end %>
        DocumentRoot <%= @doc_root %>
        ServerSignature On
        
        <Proxy *>
        <IfModule mod_authz_core.c>
         	Require all granted
        </IfModule>
        <IfModule !mod_authz_core.c>
        	Order allow,deny
          Allow from all
        </IfModule>
        </Proxy>
        
        ProxyPass        <%= @webcontext %> http://localhost:<%= @port %><%= @webcontext %>
        ProxyPassReverse <%= @webcontext %> http://localhost:<%= @port %><%= @webcontext %>
        
        <Directory />
                Options FollowSymLinks
                AllowOverride None
        </Directory>
        <Location /server-status>
          SetHandler server-status

          <IfModule mod_authz_core.c>
          Require ip 127.0.0.1
          </IfModule>
          <IfModule !mod_authz_core.c>
          Order deny,allow
          Deny from all
          Allow from 127.0.0.1
          </IfModule>

        </Location>
        
</VirtualHost>

<% end -%>